<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>US State Population Density — Choropleth</title>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.css" rel="stylesheet">
  <style>
    html, body { height: 100%; margin: 0; }
    #map { position: fixed; inset: 0; }
    #panel { position: fixed; top: 12px; right: 12px; width: 340px; max-height: calc(100vh - 24px);
             background: rgba(255,255,255,.9); color:#111; border-radius: 16px; padding: 14px;
             box-shadow: 0 10px 30px rgba(0,0,0,.25); backdrop-filter: blur(6px); }
    #panel h1 { margin: 0 0 6px; font-size: 1.05rem; }
    #legend { display:grid; grid-template-columns: 20px 1fr; gap: 8px 10px; margin-top: 10px; font-size: 12px; }
    .swatch { width: 20px; height: 12px; border-radius: 2px; border: 1px solid rgba(0,0,0,.15); }
    @media (max-width: 1024px){ #panel { display:none !important; } }
    .tip { position: absolute; pointer-events: none; background:#111; color:#fff; padding:6px 8px; border-radius:8px; font-size:12px; transform: translate(-50%,-125%); display:none; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="panel">
    <h1>Population Density by State</h1>
    <div id="legend"></div>
  </div>
  <div id="tooltip" class="tip"></div>

  <script src="https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.js"></script>
  <script>
    mapboxgl.accessToken = 'YOUR_MAPBOX_ACCESS_TOKEN';
    const BREAKS = [50,100,200,500,1000];
    const COLORS = ['#f7fbff','#deebf7','#c6dbef','#9ecae1','#6baed6','#3182bd'];

    const map = new mapboxgl.Map({ container:'map', style:'mapbox://styles/mapbox/light-v11', center:[-96,38], zoom:3.1 });
    map.addControl(new mapboxgl.NavigationControl(),'top-left');
    map.addControl(new mapboxgl.ScaleControl());

    function step(attr,breaks,colors){ const e=['step',['get',attr],colors[0]]; for (let i=0;i<breaks.length;i++) e.push(breaks[i],colors[i+1]); return e; }
    function buildLegend(breaks,colors){
      const el=document.getElementById('legend'); const ranges=[]; let prev=-Infinity;
      for (let i=0;i<breaks.length;i++){ ranges.push([prev,breaks[i]]); prev=breaks[i]; } ranges.push([prev,Infinity]);
      el.innerHTML=ranges.map((r,i)=>`<div class="swatch" style="background:${colors[i]}"></div><div>${r[0]===-Infinity?'< '+breaks[0]: r[1]===Infinity? '≥ '+breaks.at(-1) : r[0]+' – '+r[1]}</div>`).join('');
    }

    fetch('assets/stateData.geojson').then(r=>r.json()).then(states=>{
      map.on('load', ()=>{
        map.addSource('states',{type:'geojson',data:states});
        map.addLayer({id:'states-fill',type:'fill',source:'states',paint:{'fill-color':step('density',BREAKS,COLORS),'fill-opacity':0.85}});
        map.addLayer({id:'states-outline',type:'line',source:'states',paint:{'line-color':'#333','line-width':0.6}});

        const tip=document.getElementById('tooltip');
        map.on('mousemove','states-fill',(e)=>{
          const f=e.features[0]; const name=f.properties.name||'State'; const val=f.properties.density;
          tip.style.display='block'; tip.style.left=e.point.x+'px'; tip.style.top=e.point.y+'px';
          tip.innerHTML=`<strong>${name}</strong><br>Density: ${Number(val).toLocaleString()} /mi²`;
        });
        map.on('mouseleave','states-fill',()=> tip.style.display='none');

        const b=geojsonBounds(states); if (b) map.fitBounds(b,{padding:{top:20,right:(window.innerWidth>1024?340:20),bottom:20,left:20}});
        buildLegend(BREAKS,COLORS);
      });
    });

    function geojsonBounds(gj){
      if (!gj || !gj.features) return null;
      let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
      for (const f of gj.features){
        const g=f.geometry; if (!g) continue;
        const coords=g.type==='Polygon'? g.coordinates.flat(1) : g.type==='MultiPolygon'? g.coordinates.flat(2) : [];
        for (const c of coords){ const x=c[0], y=c[1];
          if (x<minX) minX=x; if (y<minY) minY=y; if (x>maxX) maxX=x; if (y>maxY) maxY=y;
        }
      } return isFinite(minX)? [[minX,minY],[maxX,maxY]]:null;
    }
  </script>
</body>
</html>
